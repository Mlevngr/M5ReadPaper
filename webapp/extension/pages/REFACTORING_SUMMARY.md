# 字体渲染模块重构说明

## 概述
本次重构将 webapp 中的字体生成和渲染逻辑按固件类型（ReadPaper 和 EDC）分离为独立模块，提高代码的可维护性和可扩展性。

## 重构内容

### 1. 新增模块文件

#### `readpaper_renderer.js`
- **功能**：ReadPaper 固件的字体渲染与打包逻辑
- **主要方法**：
  - `processBitmap()`: 处理图像数据，生成 1-bit 打包位图
  - `detectContentBounds()`: 检测内容边界用于裁剪
  - `_safePass()`: 二值域平滑（去噪 + 填洞）
  - `_pack1Bit()`: 打包为 1-bit 位图（MSB first）
- **算法特点**：
  - 单一阈值二值化
  - 可选的保守型平滑策略（避免断笔或合并笔画）
  - 与 Python 版本格式一致

#### `edc_renderer.js`
- **功能**：EDC 固件的字体渲染与打包逻辑
- **主要方法**：
  - `processBitmap()`: 处理图像数据，生成 EDC 格式压缩位图
  - `detectContentBounds()`: EDC 模式的内容边界检测
  - `createGrayscale()`: 创建反转灰度图
  - `_quantize4Bit()`: 灰度量化为 4-bit（0-15）
  - `_encodeHuffman()`: Huffman-like 可变长度编码
- **算法特点**：
  - 灰度量化而非二值化
  - 特殊的可变长度编码（背景=1bit，纯黑=2bits，灰度=6bits）
  - 压缩比更高

#### `render_helpers.js`
- **功能**：预览和 Demo 渲染的公共辅助函数
- **主要方法**：
  - `unpack1BitToImageData()`: 解包 ReadPaper 的 1-bit 位图
  - `decodeEdcToImageData()`: 解码 EDC 的压缩位图
  - `decodeBitmap()`: 根据固件模式自动选择解码方法
- **用途**：
  - 在浏览器端渲染预览图
  - Demo PNG 生成
  - 统一解码接口

### 2. 修改的文件

#### `font_worker.js`
- **改动**：
  - 引入 `readpaper_renderer.js` 和 `edc_renderer.js`
  - 移除内联的渲染和打包代码（约 200 行）
  - 使用渲染器模块的方法替代原有逻辑
  - 更新版本号为 v8-2025-01-26
- **优势**：
  - 代码更简洁（减少约 40%）
  - 固件逻辑清晰分离
  - 便于单独测试和调试

#### `main.js`
- **改动**：
  - 在 `renderDemoPNG()` 函数中使用 `RenderHelpers.decodeBitmap()`
  - 移除内联的 `unpackToImageData()` 和 `decodeEdcToImageData()` 函数（约 80 行）
  - 统一使用 `RenderHelpers` 处理位图解码
- **优势**：
  - 消除代码重复
  - 解码逻辑集中管理
  - 便于维护和更新

#### `main.html`
- **改动**：
  - 添加 `<script src="render_helpers.js"></script>`
  - 确保辅助模块在 `main.js` 之前加载

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    font_worker.js                        │
│                 (Worker 主控制器)                         │
│                                                           │
│  • 接收渲染任务                                            │
│  • 使用 opentype.js 加载字体                               │
│  • 调用渲染器模块处理位图                                   │
│  • 返回打包后的字体数据                                     │
└──────────────┬──────────────┬──────────────────────────┘
               │              │
               ▼              ▼
   ┌───────────────────┐  ┌────────────────────┐
   │ readpaper_renderer.js │  │  edc_renderer.js   │
   │  (ReadPaper 渲染器)   │  │   (EDC 渲染器)      │
   │                       │  │                    │
   │ • 阈值二值化           │  │ • 灰度量化          │
   │ • 二值域平滑           │  │ • Huffman 编码      │
   │ • 1-bit 打包           │  │ • 压缩打包          │
   └───────────────────┘  └────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      main.js                             │
│                 (浏览器端主程序)                           │
│                                                           │
│  • UI 交互控制                                             │
│  • Worker 调度                                             │
│  • 预览生成（使用 RenderHelpers）                          │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   render_helpers.js    │
              │   (公共解码辅助)        │
              │                        │
              │ • 1-bit 解码            │
              │ • EDC 解码              │
              │ • 统一接口              │
              └───────────────────────┘
```

## 优势总结

1. **模块化**：按固件类型清晰分离，职责单一
2. **可维护性**：独立文件便于定位和修改
3. **可测试性**：渲染器可独立测试，无需启动整个 Worker
4. **可扩展性**：新增固件类型只需添加新的渲染器模块
5. **代码复用**：公共辅助函数统一管理，消除重复
6. **代码量减少**：总计减少约 280 行重复/内联代码

## 二值化算法分析（已完成）

### ReadPaper 固件
- **方法**：全局固定阈值二值化
- **阈值来源**：UI 滑动条设置的 `whiteThreshold`（默认 160）
- **平滑策略**：可选的 3x3 邻域保守平滑
  - 去除孤立噪点（单像素）
  - 填补小洞（被包围的单像素）
  - 保留 1px 间隙（避免合并笔画）
- **特点**：
  - 简单高效
  - 参数可控
  - 适合大多数场景

### EDC 固件
- **方法**：灰度量化 + 可变长度编码
- **阈值**：双阈值（`whiteThreshold` 和 `blackThreshold`）
- **量化**：4-bit（0-15 级灰度）
- **编码**：Huffman-like（背景 1bit，黑色 2bit，灰度 6bit）
- **特点**：
  - 保留灰度信息
  - 压缩率高
  - 显示效果更平滑

### 改进建议（未实施）
- Otsu 自动阈值
- 局部自适应阈值（Sauvola）
- 误差扩散抖动（Floyd-Steinberg）
- 边缘检测 + 选择性平滑（Python 版本特性）

## 测试建议

1. **单元测试**：
   - 测试 `readpaper_renderer.js` 的边界检测和打包
   - 测试 `edc_renderer.js` 的量化和编码
   - 测试 `render_helpers.js` 的解码正确性

2. **集成测试**：
   - 对比重构前后生成的字体文件（二进制一致性）
   - 验证预览图渲染效果
   - 测试不同字体、字号、阈值组合

3. **性能测试**：
   - 模块化后的性能影响（预期无明显差异）
   - Worker 并发处理稳定性

## 后续工作

- [ ] 添加渲染器单元测试
- [ ] 实现 Otsu 自动阈值（可选功能）
- [ ] 添加渲染器配置文档
- [ ] 优化 EDC 编码性能
- [ ] 支持更多固件类型（扩展架构）
